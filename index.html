<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ğŸ„ ä¸å®å®åœ£è¯å¿«ä¹</title>
  <style>
    :root{
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --txt: rgba(255,255,255,.92);
      --sub: rgba(255,255,255,.72);
    }
    html,body{height:100%; margin:0;}
    body{
      overflow:hidden;
      font-family: -apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 600px at 50% 28%, rgba(120,160,255,.22), transparent 60%),
        radial-gradient(800px 600px at 15% 85%, rgba(255,120,200,.12), transparent 60%),
        radial-gradient(700px 500px at 85% 80%, rgba(90,255,200,.10), transparent 60%),
        linear-gradient(180deg, #050816, #06122b 40%, #061a3d);
      color: var(--txt);
      -webkit-tap-highlight-color: transparent;
    }
    canvas{position:fixed; inset:0; width:100vw; height:100vh; display:block;}

    .top{
      position: fixed;
      top: max(14px, env(safe-area-inset-top));
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      text-align:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--glass);
      border: 1px solid var(--glass2);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 35px rgba(0,0,0,.35);
      user-select:none;
    }
    .top .big{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .5px;
      text-shadow: 0 0 10px rgba(255,255,255,.35), 0 0 22px rgba(120,160,255,.20);
      margin:0;
      line-height: 1.2;
    }
    .top .small{
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--sub);
    }

    .bar{
      position: fixed;
      bottom: max(8px, env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      display:flex;
      gap:8px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 35px rgba(0,0,0,.35);
      user-select:none;
      max-width: 95vw;
      flex-wrap: wrap;
      justify-content: center;
    }
    .btn{
      border: 0;
      outline: none;
      color: var(--txt);
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .08s ease;
      white-space: nowrap;
    }
    .btn:active{ transform: scale(.98); }
    .note{
      font-size: 11px;
      color: rgba(255,255,255,.70);
      white-space:nowrap;
      display: none; /* æ‰‹æœºç«¯éšè—æç¤ºæ–‡å­—ï¼ŒèŠ‚çœç©ºé—´ */
    }
    @media (min-width: 600px) {
      .note { display: block; }
    }
  </style>
</head>
<body>
  <canvas id="cv"></canvas>

  <div class="top">
    <p class="big">ä¸å®å®åœ£è¯å¿«ä¹ ğŸ„âœ¨</p>
    <p class="small">ç‚¹äº®è¿™ä¸€æ£µæ ‘ï¼Œä¹Ÿç‚¹äº®ä»Šå¤©çš„ä½ </p>
  </div>

  <div class="bar">
    <button class="btn" id="playBtn">â–¶ æ’­æ”¾éŸ³ä¹</button>
    <button class="btn" id="nextBtn">â­ æ¢ä¸€é¦–</button>
    <button class="btn" id="themeBtn">ğŸŒˆ æ¢ç¯å…‰</button>
    <div class="note" id="status">ï¼ˆå¾®ä¿¡é‡Œé€šå¸¸éœ€è¦ç‚¹ä¸€ä¸‹æ‰èƒ½æœ‰å£°éŸ³ï¼‰</div>
  </div>

  <!-- ä½ æœ¬åœ°çš„ mp3 -->
  <audio id="bgm" preload="auto" loop>
    <source id="bgmSrc" src="jingle-bells-christmas-hip-hop-128137.mp3" type="audio/mpeg">
  </audio>

  <script>
    const cv = document.getElementById('cv');
    const ctx = cv.getContext('2d', { alpha: true });

    // ç¦»å± canvas ç”¨äºé™æ€å±‚ç¼“å­˜
    const sc = document.createElement('canvas');
    const sctx = sc.getContext('2d', { alpha: true });
    let staticDirty = true; // é™æ€å±‚éœ€è¦é‡ç»˜å—ï¼Ÿ

    let W=0,H=0,DPR=1;
    function resize(){
      DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      W = Math.floor(innerWidth);
      H = Math.floor(innerHeight);
      cv.width = Math.floor(W * DPR);
      cv.height = Math.floor(H * DPR);
      cv.style.width = W+'px';
      cv.style.height = H+'px';
      ctx.setTransform(DPR,0,0,DPR,0,0);
      
      // ç¦»å± canvas ä¹Ÿè¦åŒæ­¥å°ºå¯¸
      sc.width = cv.width;
      sc.height = cv.height;
      sctx.setTransform(DPR,0,0,DPR,0,0);
      staticDirty = true;
    }
    addEventListener('resize', resize, {passive:true});
    resize();

    const rand=(a,b)=>a+Math.random()*(b-a);
    const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

    const themes = [
      ["#ff5a5f","#ffd36a","#5cffc4","#4ea1ff","#b47cff"],
      ["#ffd36a","#fff2c8","#ffffff","#ffd36a","#fff8e6"],
      ["#4ea1ff","#8bd3ff","#cfefff","#6ad7ff","#b6f3ff"],
      ["#ff4d6d","#ffb3c1","#fff0f3","#ff8fab","#ffd6e0"],
    ];
    let themeIdx = 0;

    // ====== çƒŸèŠ±ç²’å­ï¼ˆç‚¹å‡»æ˜Ÿæ˜Ÿè§¦å‘ï¼‰======
    const fireworks = [];
    let starPos = { x: 0, y: 0, r: 30 }; // æ˜Ÿæ˜Ÿä½ç½®ï¼Œç”¨äºç‚¹å‡»æ£€æµ‹

    function spawnFirework(x, y){
      const palette = themes[themeIdx];
      const burst = 42; // ç²’å­æ•°é‡ï¼ˆæ‰‹æœºåˆ«å¤ªå¤šï¼‰
      for(let i=0;i<burst;i++){
        const ang = Math.random() * Math.PI * 2;
        const spd = rand(1.2, 4.2) * (0.85 + Math.random()*0.35);
        fireworks.push({
          x, y,
          vx: Math.cos(ang)*spd,
          vy: Math.sin(ang)*spd - rand(0.6, 2.0),
          r: rand(1.0, 2.2),
          life: rand(28, 46),   // å¸§å¯¿å‘½
          t: 0,
          c: palette[Math.floor(rand(0, palette.length))]
        });
      }
    }

    function updateAndDrawFireworks(){
      // è½»å¾®é‡åŠ› + æ‘©æ“¦
      for(let i=fireworks.length-1;i>=0;i--){
        const p = fireworks[i];
        p.t++;
        p.x += p.vx;
        p.y += p.vy;
        p.vx *= 0.985;
        p.vy = p.vy*0.985 + 0.06; // gravity
        const alpha = 1 - (p.t / p.life);
        drawGlow(ctx, p.x, p.y, p.r, p.c, alpha, 22);

        // å°å°¾ç„°ï¼šæ›´"çƒŸèŠ±"
        if(p.t % 2 === 0){
          drawGlow(ctx, p.x - p.vx*1.2, p.y - p.vy*1.2, p.r*0.7, "rgba(255,255,255,1)", alpha*0.20, 18);
        }

        if(p.t >= p.life) fireworks.splice(i, 1);
      }
    }

    // èƒŒæ™¯ bokehï¼ˆå°‘ä¸€ç‚¹ï¼Œåˆ«ç³Šæ»¡å±ï¼‰
    let bokeh=[];
    function initBokeh(){
      bokeh = Array.from({length: 36}, () => ({
        x: rand(0, W), y: rand(0,H),
        r: rand(18, 70),
        a: rand(0.02, 0.06),
        vx: rand(-0.04, 0.04),
        vy: rand(-0.03, 0.03)
      }));
    }
    initBokeh();

    // é›ªèŠ±
    const snow=[];
    function initSnow(){
      snow.length=0;
      const n = Math.floor(clamp(W*H/20000, 70, 160));
      for(let i=0;i<n;i++){
        snow.push({
          x: rand(0,W), y: rand(0,H),
          r: rand(0.8, 2.5),
          vx: rand(-0.22, 0.22),
          vy: rand(0.7, 1.9),
          a: rand(0.22, 0.85)
        });
      }
    }
    initSnow();

    // ===== æ ‘ï¼šå…³é”®æ”¹åŠ¨ï¼å…ˆâ€œå‰ªå½±â€ï¼Œå†å½©ç¯ =====
    // å½©ç¯ç‚¹äº‘ï¼šåˆ†å¸ƒåœ¨æ ‘çš„ä¸‰è§’åŒºåŸŸå†…ï¼ˆä¸æ˜¯ä¸€æ¡èºæ—‹çº¿ï¼‰
    const lights=[];
    const garland=[]; // èŠ±ç¯ï¼ˆèºæ—‹å¸¦ï¼‰
    function initTree(){
      lights.length=0;
      garland.length=0;

      const count = 1100; // å½©ç¯ç‚¹ï¼ˆåŒå±‚æ¸²æŸ“åæ€§èƒ½è¶³å¤Ÿï¼‰
      for(let i=0;i<count;i++){
        const t = Math.random();           // 0..1 ä»é¡¶åˆ°åº•
        const u = (Math.random()*2-1);     // -1..1 æ¨ªå‘
        lights.push({
          t,
          u,
          // ç‚¹åŠå¾„ï¼šä¸‹æ–¹ç¨å¤§
          r: rand(0.9, 2.2) * (0.7 + t*1.1),
          phase: rand(0, Math.PI*2),
          speed: rand(0.7, 1.7),
          cidx: Math.floor(rand(0, themes[0].length))
        });
      }

      // èŠ±ç¯ï¼šå¤šåœˆèºæ—‹å¸¦ï¼ˆå¾ˆå‡ºæ°›å›´ï¼‰
      const rings = 10;
      for(let k=0;k<rings;k++){
        const baseT = 0.12 + k*(0.80/(rings-1));
        const seg = 140; // æ¯åœˆç‚¹æ•°
        for(let i=0;i<seg;i++){
          const a = (i/seg)*Math.PI*2;
          garland.push({
            t: baseT + rand(-0.012, 0.012),
            a: a + rand(-0.10, 0.10),
            r: rand(1.0, 2.0),
            phase: rand(0, Math.PI*2),
            speed: rand(0.9, 1.8),
          });
        }
      }
    }
    initTree();

    function drawGlow(c, x,y,r,color,alpha,blur=18){
      c.save();
      c.globalAlpha = alpha;
      c.fillStyle = color;
      c.shadowColor = color;
      c.shadowBlur = blur;
      c.beginPath();
      c.arc(x,y,r,0,Math.PI*2);
      c.fill();
      c.restore();
    }

    function drawStar(c, cx, cy, spikes, outerR, innerR){
      let rot = Math.PI / 2 * 3;
      const step = Math.PI / spikes;
      c.beginPath();
      c.moveTo(cx, cy - outerR);
      for (let i = 0; i < spikes; i++) {
        c.lineTo(cx + Math.cos(rot) * outerR, cy + Math.sin(rot) * outerR);
        rot += step;
        c.lineTo(cx + Math.cos(rot) * innerR, cy + Math.sin(rot) * innerR);
        rot += step;
      }
      c.closePath();
    }

    function drawTreeSilhouette(c, cx, topY, baseY, halfW){
      // ä¸‰å±‚"æ¾å¶"å‰ªå½±ï¼šä¿è¯æ ‘å½¢
      const layers = [
        {y: topY, w: halfW*0.55, h: (baseY-topY)*0.32, a: 0.38},
        {y: topY+(baseY-topY)*0.18, w: halfW*0.78, h: (baseY-topY)*0.40, a: 0.32},
        {y: topY+(baseY-topY)*0.38, w: halfW*1.00, h: (baseY-topY)*0.50, a: 0.28},
      ];

      for(const L of layers){
        const grad = c.createLinearGradient(cx, L.y, cx, L.y+L.h);
        grad.addColorStop(0, `rgba(80,255,190,${L.a})`);
        grad.addColorStop(1, `rgba(10,80,60,0)`);
        c.fillStyle = grad;

        c.beginPath();
        c.moveTo(cx, L.y);
        c.lineTo(cx - L.w, L.y + L.h);
        c.lineTo(cx + L.w, L.y + L.h);
        c.closePath();
        c.fill();

        // å ä¸€å±‚æš—ç»¿æœ¬ä½“
        c.fillStyle = `rgba(18,120,80,${L.a+0.10})`;
        c.beginPath();
        c.moveTo(cx, L.y + 6);
        c.lineTo(cx - L.w*0.95, L.y + L.h);
        c.lineTo(cx + L.w*0.95, L.y + L.h);
        c.closePath();
        c.fill();
      }
    }

    function drawTrunk(c, cx, baseY, halfW){
      const trunkW = Math.max(18, Math.min(40, halfW*0.22));
      const trunkH = Math.max(60, Math.min(110, H*0.13));
      const x = cx - trunkW/2;
      const y = baseY - trunkH*0.05; // è®©å®ƒæ’è¿›æ ‘é‡Œä¸€ç‚¹

      // æŠ•å½±
      c.save();
      c.fillStyle = "rgba(0,0,0,.28)";
      c.shadowColor = "rgba(0,0,0,.55)";
      c.shadowBlur = 18;
      c.beginPath();
      c.ellipse(cx, baseY+8, trunkW*0.75, trunkW*0.28, 0, 0, Math.PI*2);
      c.fill();
      c.restore();

      // ä¸»ä½“æ¸å˜
      const g = c.createLinearGradient(x, y, x+trunkW, y);
      g.addColorStop(0, "rgba(150,95,45,.92)");
      g.addColorStop(0.55, "rgba(110,70,34,.95)");
      g.addColorStop(1, "rgba(80,50,24,.92)");
      c.fillStyle = g;
      c.beginPath();
      roundRect(c, x, y, trunkW, trunkH, 10);
      c.fill();

      // é«˜å…‰
      c.fillStyle = "rgba(255,210,150,.10)";
      c.beginPath();
      roundRect(c, x + trunkW*0.18, y + trunkH*0.10, trunkW*0.18, trunkH*0.72, 10);
      c.fill();

      // è½»å¾®å‘å…‰èå…¥
      drawGlow(c, cx, y + trunkH*0.55, trunkW*1.1, "rgba(150,95,45,1)", 0.05, 22);
    }

    function roundRect(c, x, y, w, h, r){
      r = Math.min(r, w/2, h/2);
      c.moveTo(x+r, y);
      c.arcTo(x+w, y, x+w, y+h, r);
      c.arcTo(x+w, y+h, x, y+h, r);
      c.arcTo(x, y+h, x, y, r);
      c.arcTo(x, y, x+w, y, r);
      c.closePath();
    }

    // è·å–åœºæ™¯å‚æ•°ï¼ˆç»Ÿä¸€è®¡ç®—ï¼Œé¿å… UI é®æŒ¡ï¼‰
    function getScene(){
      const cx = W*0.5;
      let topY = H*0.18;
      let height = H*0.55;
      let baseY = topY + height;
      const halfW = Math.min(W*0.23, H*0.20);
      
      // é¿å…åº•éƒ¨æ§åˆ¶æ é®æŒ¡
      try{
        const bar = document.querySelector('.bar');
        if(bar){
          const barH = bar.getBoundingClientRect().height + 14;
          const maxBaseY = H - barH;
          if(baseY > maxBaseY){
            const shift = baseY - maxBaseY;
            baseY -= shift;
            height -= shift;
          }
        }
      }catch(e){}
      
      return { cx, topY, height, baseY, halfW };
    }

    // ç»˜åˆ¶é™æ€å±‚ï¼ˆåªç”»ä¸€æ¬¡ï¼Œç¼“å­˜åˆ°ç¦»å± canvasï¼‰
    function drawStaticLayer(){
      sctx.clearRect(0,0,W,H);
      
      const { cx, topY, height, baseY, halfW } = getScene();
      
      // åœ°é¢ä¸˜é™µ
      sctx.save();
      const hill = sctx.createRadialGradient(cx, baseY+H*0.24, 10, cx, baseY+H*0.24, W*0.75);
      hill.addColorStop(0, "rgba(40,130,110,.18)");
      hill.addColorStop(1, "rgba(0,0,0,0)");
      sctx.fillStyle = hill;
      sctx.beginPath();
      sctx.ellipse(cx, baseY+H*0.18, W*0.52, H*0.22, 0, 0, Math.PI*2);
      sctx.fill();
      sctx.restore();
      
      // æ ‘å‰ªå½±
      drawTreeSilhouette(sctx, cx, topY, baseY, halfW);
      
      // æ ‘å¹²
      drawTrunk(sctx, cx, baseY, halfW);
      
      // èŠ±ç¯åº•è‰²ï¼ˆé™æ€å±‚åªç”»å›ºå®šäº®åº¦ï¼Œä¸é—ªçƒï¼‰
      const wiggle = 0; // é™æ€å±‚ä¸æ‘†åŠ¨
      for(const g of garland){
        const t01 = g.t;
        const y = topY + t01*height;
        const w = halfW * (0.18 + t01*0.98);
        const x = cx + Math.cos(g.a + wiggle) * w;
        // åªç”»ä¸€ä¸ªå›ºå®šäº®åº¦åº•è‰²ï¼Œä¿æŒé«˜çº§æ„Ÿ
        drawGlow(sctx, x, y, g.r*1.2, "rgba(255,211,106,1)", 0.18, 18);
      }
      
      staticDirty = false;
    }

    // è½»å¾®äº¤äº’ï¼šå·¦å³æ»‘åŠ¨æ”¹å˜"èŠ±ç¯æ‘†åŠ¨"ï¼ˆåˆ«è®©æ ‘ä¹±è½¬ï¼‰
    let sway = 0;
    let lastX = null;
    addEventListener('pointerdown', e => { lastX = e.clientX; }, {passive:true});
    addEventListener('pointermove', e => {
      if(lastX==null) return;
      const dx = e.clientX - lastX;
      sway = clamp(dx/300, -1, 1);
    }, {passive:true});
    addEventListener('pointerup', ()=>{ lastX=null; sway=0; }, {passive:true});

    function tick(t){
      // å…ˆç»˜åˆ¶é™æ€å±‚ï¼ˆå¦‚æœéœ€è¦ï¼‰
      if(staticDirty) drawStaticLayer();
      
      // æ¸…ç©ºä¸»ç”»å¸ƒï¼Œç„¶åç›´æ¥è´´é™æ€å±‚
      ctx.clearRect(0,0,W,H);
      ctx.drawImage(sc, 0, 0, W, H);

      // è·å–åœºæ™¯å‚æ•°
      const { cx, topY, height, baseY, halfW } = getScene();
      const palette = themes[themeIdx];

      // === åŠ¨æ€å±‚ï¼šåªç”»ä¼šå˜åŒ–çš„éƒ¨åˆ† ===
      
      // bokeh
      for(const b of bokeh){
        b.x += b.vx; b.y += b.vy;
        if(b.x<-90) b.x=W+90; if(b.x>W+90) b.x=-90;
        if(b.y<-90) b.y=H+90; if(b.y>H+90) b.y=-90;
        drawGlow(ctx, b.x, b.y, b.r, "rgba(255,255,255,1)", b.a, 26);
      }

      // é›ª
      ctx.save();
      ctx.fillStyle="rgba(255,255,255,.9)";
      for(const s of snow){
        s.x += s.vx; s.y += s.vy;
        if(s.y>H+10){ s.y=-10; s.x=rand(0,W); }
        if(s.x<-10) s.x=W+10;
        if(s.x>W+10) s.x=-10;
        ctx.globalAlpha = s.a;
        ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();

      // èŠ±ç¯é—ªçƒå±‚ï¼ˆåŠ¨æ€éƒ¨åˆ†ï¼Œå åŠ åœ¨é™æ€åº•è‰²ä¸Šï¼‰
      const wiggle = Math.sin(t*0.0012)*0.25 + sway*0.35;
      for(const g of garland){
        const t01 = g.t;
        const y = topY + t01*height;
        const w = halfW * (0.18 + t01*0.98);
        const x = cx + Math.cos(g.a + wiggle + t*0.0007) * w;

        const tw = 0.35 + 0.55*(0.5 + 0.5*Math.sin(g.phase + t*0.004*g.speed));
        // åªç”»é—ªçƒå¢é‡éƒ¨åˆ†
        const extraAlpha = 0.35 * tw;
        if(extraAlpha > 0.05){
          drawGlow(ctx, x, y, g.r*(1.0+0.35*tw), "rgba(255,211,106,1)", extraAlpha, 20);
        }
      }

      // å½©ç¯ç‚¹äº‘ï¼ˆå‡åŒ€é“ºæ»¡æ ‘ä½“ï¼‰
      for(const p of lights){
        const t01 = p.t;
        const y = topY + t01*height;

        // å…³é”®ï¼šæ¨ªå‘å®½åº¦éšé«˜åº¦å˜åŒ– => ä¸‰è§’æ ‘ä½“
        const w = halfW * (0.10 + t01*1.05);
        const x = cx + p.u * w + rand(-0.6,0.6);

        // è®©è¾¹ç¼˜å°‘ä¸€ç‚¹ç¯ï¼ˆæ›´åƒåœ¨æ ‘é‡Œï¼‰
        const edge = Math.abs(p.u);
        const edgeFade = 1 - Math.pow(edge, 1.7);

        const tw = 0.35 + 0.55*(0.5 + 0.5*Math.sin(p.phase + t*0.004*p.speed));
        const col = palette[p.cidx % palette.length];
        const alpha = clamp((0.18 + 0.58*tw) * edgeFade, 0, 1);

        drawGlow(ctx, x, y, p.r*(0.95+0.25*tw), col, alpha, 18);
      }

      // é¡¶éƒ¨æ˜Ÿæ˜Ÿ
      const starY = topY - 18;
      const pulse = 0.72 + 0.28*Math.sin(t*0.004);
      ctx.save();
      ctx.globalAlpha = 0.96;
      ctx.fillStyle = "rgba(255,211,106,.95)";
      ctx.shadowColor = "rgba(255,211,106,1)";
      ctx.shadowBlur = 34;
      drawStar(ctx, cx, starY, 5, 18*pulse, 8*pulse);
      ctx.fill();
      ctx.restore();
      drawGlow(ctx, cx, starY, 28, "rgba(255,211,106,1)", 0.14, 30);
      drawGlow(ctx, cx, starY, 52, "rgba(255,211,106,1)", 0.07, 34);

      // æ›´æ–°æ˜Ÿæ˜Ÿä½ç½®ï¼ˆç”¨äºç‚¹å‡»æ£€æµ‹ï¼‰
      starPos.x = cx;
      starPos.y = starY;
      starPos.r = 30;

      // ç»˜åˆ¶çƒŸèŠ±ç²’å­
      updateAndDrawFireworks();

      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // ===== éŸ³ä¹ï¼ˆä¿ç•™ä½ çš„é€»è¾‘ï¼‰=====
    const bgm = document.getElementById('bgm');
    const bgmSrc = document.getElementById('bgmSrc');
    const playBtn = document.getElementById('playBtn');
    const nextBtn = document.getElementById('nextBtn');
    const themeBtn = document.getElementById('themeBtn');
    const status = document.getElementById('status');

    const tracks = [
      "jingle-bells-christmas-hip-hop-128137.mp3",
      "we-wish-you-a-merry-christmas-444573.mp3"
    ];
    let trackIdx = 0;

    async function tryPlay(){
      try{
        if(bgm.readyState < 2) {
          // å¦‚æœéŸ³é¢‘è¿˜æ²¡åŠ è½½å¥½ï¼Œç­‰å¾…ä¸€ä¸‹
          await new Promise(resolve => {
            bgm.addEventListener('canplay', resolve, {once: true});
            setTimeout(resolve, 100); // è¶…æ—¶ä¿æŠ¤
          });
        }
        await bgm.play();
        playBtn.textContent = "â¸ æš‚åœéŸ³ä¹";
        status.textContent = "éŸ³ä¹å·²æ’­æ”¾ ğŸ¶ï¼ˆå†ç‚¹å¯æš‚åœï¼‰";
      }catch(e){
        status.textContent = "ç‚¹ä¸€ä¸‹ã€Œæ’­æ”¾éŸ³ä¹ã€å³å¯ï¼ˆå¾®ä¿¡/æµè§ˆå™¨ç­–ç•¥é™åˆ¶ï¼‰";
      }
    }

    playBtn.addEventListener('click', async ()=>{
      if(!bgm.paused){
        bgm.pause();
        playBtn.textContent = "â–¶ æ’­æ”¾éŸ³ä¹";
        status.textContent = "å·²æš‚åœï¼ˆå†ç‚¹ç»§ç»­ï¼‰";
        return;
      }
      await tryPlay();
    });

    // åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–æ­Œ
    async function nextTrack(shouldAutoPlay = null){
      // è®°å½•åˆ‡æ¢å‰çš„æ’­æ”¾çŠ¶æ€ï¼ˆå¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä½¿ç”¨å½“å‰çŠ¶æ€ï¼‰
      const wasPlaying = shouldAutoPlay !== null ? shouldAutoPlay : !bgm.paused;
      
      trackIdx = (trackIdx + 1) % tracks.length;
      bgmSrc.src = tracks[trackIdx];
      bgm.load();
      status.textContent = `å·²åˆ‡æ¢åˆ°ç¬¬ ${trackIdx + 1} é¦– ğŸµ`;
      
      // ç­‰å¾…éŸ³é¢‘åŠ è½½å®Œæˆ
      await new Promise(resolve => {
        if(bgm.readyState >= 2) {
          resolve();
        } else {
          bgm.addEventListener('canplay', resolve, {once: true});
          setTimeout(resolve, 500); // è¶…æ—¶ä¿æŠ¤
        }
      });
      
      // å¦‚æœä¹‹å‰æ­£åœ¨æ’­æ”¾ï¼Œè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
      if(wasPlaying){
        await tryPlay();
      } else {
        playBtn.textContent = "â–¶ æ’­æ”¾éŸ³ä¹";
      }
    }

    nextBtn.addEventListener('click', async ()=>{
      // ç‚¹å‡»"æ¢ä¸€é¦–"æŒ‰é’®æ—¶ï¼Œæ€»æ˜¯å°è¯•è‡ªåŠ¨æ’­æ”¾
      await nextTrack(true);
    });

    // å½“ä¸€é¦–æ­Œæ’­æ”¾å®Œæ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–
    bgm.addEventListener('ended', async ()=>{
      await nextTrack();
    });

    themeBtn.addEventListener('click', ()=>{
      themeIdx = (themeIdx + 1) % themes.length;
      // æ¢ç¯å…‰ä¸»é¢˜ï¼šé‡æŒ‘é¢œè‰²
      for(const p of lights){
        p.cidx = Math.floor(rand(0, themes[themeIdx].length));
      }
      staticDirty = true; // ä¸»é¢˜åˆ‡æ¢éœ€è¦é‡ç»˜é™æ€å±‚
      status.textContent = "ç¯å…‰ä¸»é¢˜å·²åˆ‡æ¢ âœ¨";
    });

    // é¡µé¢åŠ è½½åå°è¯•è‡ªåŠ¨æ’­æ”¾
    window.addEventListener('load', async ()=>{
      // å»¶è¿Ÿä¸€ç‚¹ï¼Œç¡®ä¿éŸ³é¢‘å…ƒç´ å·²å‡†å¤‡å¥½
      setTimeout(async ()=>{
        await tryPlay();
      }, 300);
    });

    // é¦–æ¬¡è§¦æ‘¸/ç‚¹å‡»ä¹Ÿå°è¯•æ’­æ”¾ï¼ˆä½œä¸ºå¤‡é€‰ï¼Œä½†æ’é™¤æŒ‰é’®åŒºåŸŸï¼‰
    let hasUserInteracted = false;
    document.addEventListener('pointerup', (e)=>{
      // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®åŒºåŸŸï¼Œæ ‡è®°å·²äº¤äº’ä½†ä¸å¤„ç†ï¼ˆè®©æŒ‰é’®è‡ªå·±çš„äº‹ä»¶å¤„ç†ï¼‰
      if(e.target.closest('.bar')) {
        hasUserInteracted = true;
        return;
      }
      // åªåœ¨ç¬¬ä¸€æ¬¡éæŒ‰é’®ç‚¹å‡»æ—¶å°è¯•æ’­æ”¾
      if(!hasUserInteracted && bgm.paused) {
        tryPlay();
        hasUserInteracted = true;
      }
    }, {once:true});

    addEventListener('resize', ()=>{
      resize(); // è¿™ä¼šè®¾ç½® staticDirty = true
      initSnow();
      initBokeh();
      initTree();
    }, {passive:true});

    // ç‚¹å‡»æ˜Ÿæ˜Ÿï¼šçˆ†çƒŸèŠ±
    cv.addEventListener('pointerup', (e)=>{
      const rect = cv.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const dx = x - starPos.x;
      const dy = y - starPos.y;
      if(dx*dx + dy*dy <= starPos.r*starPos.r){
        spawnFirework(starPos.x, starPos.y);
      }
    }, {passive:true});
  </script>
</body>
</html>
